/**
 * @file Code.gs
 * @description 議事録生成アプリのバックエンド処理 (SPA対応版)
 */

// ==========================================
// 1. Webアプリのホスティング
// ==========================================

/**
 * WebアプリのGETリクエストを処理する
 * @param {object} e - イベントオブジェクト
 * @returns {HtmlOutput} HTML出力
 */
function doGet(e) {
  // SPA（シングルページ）として、常にscreen1.htmlだけを返す
  return HtmlService.createHtmlOutputFromFile('screen1.html')
    .setTitle('議事録管理システム');
}

/**
 * 別のHTMLファイルをインクルードするためのヘルパー関数
 * @param {string} filename - インクルードするHTMLファイル名
 * @returns {string} ファイルの内容
 */
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}


// ==========================================
// 2. AIによる議事録生成（GeminiRaytech）
// ==========================================

/**
 * フロントエンドから文字起こしテキストを受け取り、AIで処理して構造化データを返す
 * @param {string} rawTranscript - ユーザーがアップロードした文字起こしテキスト
 * @returns {object} AIが生成した議事録データ（JSON形式）
 */
function processTranscriptWithAI(rawTranscript) {
  try {
    var prompt = createPromptForMinutes(rawTranscript);

    // モデルIDを指定
    var modelId = "gemini-2.5-flash"; 

    // GeminiRaytechの関数を呼び出し
    var jsonString = GeminiRaytech.generateText(prompt, modelId);

    // AIが返すJSON文字列をクリーンアップ (マークダウンの```json ```などを削除)
    var cleanedJsonString = jsonString.replace(/```json\n|```/g, "").trim();

    // 文字列をJSONオブジェクトにパース
    var structuredData = JSON.parse(cleanedJsonString);

    return { status: "success", data: structuredData };

  } catch (e) {
    Logger.log(e);
    // エラーの場合もフロントエンドに返す
    return { status: "error", message: e.message };
  }
}

/**
 * Geminiに投げるための詳細なプロンプトを生成する (rowspan対応版)
 * @param {string} rawTranscript - 文字起こしテキスト
 * @returns {string} AIへの指示（プロンプト）
 */
function createPromptForMinutes(rawTranscript) {
  var promptLines = [
    "あなたは建設工事の議事録作成アシスタントです。",
    "以下の「入力テキスト」（会議の文字起こし）を読み取り、",
    "指定された「出力フォーマット」のJSON形式で議事録を生成してください。",
    "",
    "# 入力テキスト",
    "\"\"\"",
    rawTranscript,
    "\"\"\"",
    "",
    "# 出力フォーマット (JSON)",
    "必ず、以下のJSON構造「のみ」を出力してください。",
    "{",
    "  \"header\": {",
    "    \"kouji_mei\": \"（工事名を抽出）\",",
    "    \"date_time\": \"（打合せ日時を抽出）\",",
    "    \"basyo\": \"（打合せ場所を抽出）\",",
    "    \"shusseki\": \"（出席者情報を抽出）\"",
    "  },",
    // 議題リスト: 番号とタイトルをオブジェクトにする
    "  \"agenda\": [",
    "    { \"no\": 1, \"title\": \"（議題1のタイトル）\" },",
    "    { \"no\": 2, \"title\": \"（議題2のタイトル）\" }",
    "  ],",
    // 議論リスト: どの議題(no)に属するかを \"topic_no\" で紐付ける
    "  \"main\": [",
    "    { \"topic_no\": 1, \"content\": \"（議題1に関する具体的な議論内容）\", \"speaker\": \"（発言者）\", \"result\": \"（結論ファーストの要約）\", \"responder\": \"（回答者）\" },",
    "    { \"topic_no\": 2, \"content\": \"（議題2に関する議論A）\", \"speaker\": \"（発言者A）\", \"result\": \"（結論A）\", \"responder\": \"（回答者A）\" },",
    "    { \"topic_no\": 2, \"content\": \"（議題2に関する議論B）\", \"speaker\": \"（発言者B）\", \"result\": \"（結論B）\", \"responder\": \"（回答者B）\" }",
    "  ],",
    "  \"mechanical\": [],",
    "  \"electrical\": []",
    "}",
    "",
    "# 厳守すべき指示 (重要)",
    "",
    "## 1. ヘッダーと議題 (header, agenda)",
    "- `header` の情報（工事名、日時、場所、出席者）を正確に抽出してください。",
    "- `agenda` には、会議の議題を「番号(no)」と「タイトル(title)」のオブジェクト配列としてリストアップしてください。",
    "",
    "## 2. 議論リスト (main)",
    "- 会議の主要な議論を、時系列で `main` 配列に分類してください。",
    "- `main` の各項目には、それが `agenda` のどの議題番号に属するかを示す `topic_no` を必ず付与してください。",
    "- `main.content` には、「【議題名】」は含めず、**その議論の具体的な内容（例: 「上段駐車場と下段駐車場の間の法面について」）** のみを記載してください。",
    "- `main.result` には、その議論の「結論」を必ず文章の先頭に記述し（結論ファースト）、2〜3行程度の簡潔な要約にしてください。",
    "- `speaker`（発言者）と `responder`（回答者）は、不明な場合は空欄 `\"\"` にしてください。",
    "",
    "## 3. その他",
    "- `main` には `no` を含めないでください（`topic_no` を使います）。",
    "- 抽出できない項目は空欄 `\"\"` にしてください。",
    "- JSONオブジェクトのみを出力してください。前後の説明文は一切不要です。"
  ];

  return promptLines.join("\n");
}

// ==========================================
// 3. データベース（Googleスプレッドシート）連携 (ダミー)
// ==========================================

/**
 * [ダミー] 議事録一覧を返す
 */
function loadMinutesList() {
  // 本来はGoogleスプレッドシートなどから読み込む
  return [
    { id: "009", name: "第9回定例打合せ", date: "2025/09/18", editor: "田中" },
    { id: "008", name: "第8回定例打合せ", date: "2025/09/05", editor: "鈴木" },
    { id: "007", name: "第7回定例打合せ", date: "2025/08/22", editor: "田中" },
  ];
}

/**
 * [ダミー] 議事録データを保存する
 * @param {object} minuteData - フロントエンドから送られてくる議事録データ
 */
function saveMinuteData(minuteData) {
  // 本来はGoogleスプレッドシートに書き込む
  Logger.log("以下のデータが保存されました:");
  Logger.log(JSON.stringify(minuteData));
  return { status: "success", id: minuteData.id || "new_id_123" };
}

/**
 * [ダミー] 議事録を検索する
 * @param {string} query - 検索クエリ
 */
function searchMinutes(query) {
  // 本来はスプレッドシートを検索
  return [
    { id: "008", name: "第8回定例打合せ", date: "2025/09/05", editor: "鈴木" }
  ];
}
